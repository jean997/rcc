---
title: "Simple Example"
author: "Jean Morrison"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simple Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, warning=FALSE}
library(rcc)
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

This walks through the code used to produce the example shown in figure 1 in section 1.3 of "Rank conditional coverage and confidence intervals in high dimensional problems."


The first step is to generate the four vectors of true effects:
```{r}
set.seed(14590424)
titles <- c("All Zero", "All N(0, 1)", "100 Effects=3", "100 Effects N(0, 1)")
example_params <- cbind(rep(0, 1000), 
                        rnorm(n=1000), 
                        rep(c(0, 3), c(900, 100)), 
                        c(rep(0, 900), rnorm(100)))
```
This matrix is also included as a builtin data set in this package.

```{r, show='hold'}
titles <- c("All Zero", "All N(0, 1)", "100 Effects=3", "100 Effects N(0, 1)")
for(i in 1:4){
  hist(example_params[,i], breaks=15, main=titles[i], xlab="Theta")
}
```


The function `example_sim` takes a vector of true parameter values, $\theta$, and the number of simulations to run. For each simulation it generates a vector of observed statistics as 
$$ z_i \sim N(\theta_i, 1).$$
From this vector of statistics we generate confidence intervals using five different methods, recording interval width and coverage rates. The five methods described in the paper are:

* naive
* oracle rank conditional pivotal intervals
* parametric bootstrap intervals
* selection adjusted intervals described by Weinstein et al (2013)
* sliding thershold variation of the Weinstein et al intervals

The function used to generage the oracle and parametric bootstrap intervals s `par_bs_ci` which ranks estimates based on $t$-statistics.

The following prduces the simulation results shown in the paper:

```{r, eval=FALSE}
set.seed(6587900)
sim.list <- list()
for(i in 1:4){
  sim.list[[i]] <- example_sim(example_params[,i], n=200, use.abs=TRUE)
}
```
Each simulation object is a list containing matrices of the raw data generated and two 5 by 1000 by 200 arrays giving the coverage and interval width for each of five types of intervals at for each rank over 200 replications (see documentation for `example_sim`). 
```{r}
names(sim.list[[1]])
sim.list[[1]]$simnames
dim(sim.list[[1]]$COVERAGE)
dim(sim.list[[1]]$WIDTH)
```

## Plotting
Plots can be created with the `plot_coverage` and `plot_width` functions.

```{r}
covplots <- list()
widthplots <- list()
for(i in 1:4){
  if(i==4) lp <- "right"
    else lp <- "none"
  covplots[[i]] <- plot_coverage(sim.list[[i]], proportion=0.2,
                                 cols=c("black",  "deeppink3",  "blue", "forestgreen"),
                                shapes= c(1,  0, 4, 2), main=titles[i],
                               simnames=c("naive",  "par", "oracle", "ash"),
                               legend.names = c("Marginal", "Parametric Bootstrap", "Oracle", "ASH"), legend.position = lp)
  widthplots[[i]] <- plot_width(sim.list[[i]], proportion=0.2,
                                 cols=c("black",  "deeppink3",  "blue", "forestgreen"),
                                shapes= c(1,  0, 4, 2), main=titles[i],
                               simnames=c("naive",  "par", "oracle", "ash"),
                               legend.names = c("Marginal", "Parametric Bootstrap", "Oracle", "ASH"), legend.position = lp)

}

h1 <- grid.arrange(covplots[[1]], covplots[[2]], covplots[[3]], covplots[[4]], ncol=4, widths=rep(c(4, 6), c(3, 1)))
h2 <- grid.arrange(widthplots[[1]], widthplots[[2]], widthplots[[3]], widthplots[[4]], ncol=4, widths=rep(c(4, 6), c(3, 1)))
h <- grid.arrange(h1, h2, ncol=1)
ggsave(h, file="~/Desktop/rcc-temp/for_jcgs/simple_example_with_ash.png", heigh=8, width=16, units="in", dpi=300)
```

```{r, fig.show='hold', fig.width=6.5}
plot_coverage(sim.list[[2]], proportion=0.2,
              cols=c("black", "forestgreen", "deeppink3", "gold4", "blue"),
              shapes= c(1, 3, 0, 2, 4),
              simnames=c("naive", "wfb2", "par", "wfb", "oracle"),
              legend.names = c("Marginal", "WFB-Sliding", "Parametric Bootstrap", "WFB", "Oracle"), legend.position = "right")
```

